# ğŸ³ Tournament Management System - Backend Dockerfile
# í”„ë¡œë•ì…˜ í™˜ê²½ì„ ìœ„í•œ Node.js ë°±ì—”ë“œ ì»¨í…Œì´ë„ˆ

# ===== Build Stage =====
FROM node:18-alpine AS builder

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ (Prisma ë“±ì„ ìœ„í•œ openssl)
RUN apk add --no-cache openssl

# package.jsonê³¼ package-lock.json ë³µì‚¬
COPY package*.json ./

# ì˜ì¡´ì„± ì„¤ì¹˜ (ê°œë°œ ì˜ì¡´ì„± í¬í•¨)
RUN npm ci

# ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬
COPY . .

# Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„±
RUN npx prisma generate

# TypeScript ë¹Œë“œ
RUN npm run build

# ===== Production Stage =====
FROM node:18-alpine AS production

# ë³´ì•ˆì„ ìœ„í•œ non-root ì‚¬ìš©ì ìƒì„±
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
RUN apk add --no-cache openssl dumb-init

# package.jsonê³¼ package-lock.json ë³µì‚¬
COPY package*.json ./

# í”„ë¡œë•ì…˜ ì˜ì¡´ì„±ë§Œ ì„¤ì¹˜
RUN npm ci --only=production && npm cache clean --force

# ë¹Œë“œëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³µì‚¬
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma

# ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ì†Œìœ ê¶Œ ë³€ê²½
RUN chown -R nodejs:nodejs /app
USER nodejs

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=production
ENV PORT=5000

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 5000

# í—¬ìŠ¤ì²´í¬ ì¶”ê°€
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node healthcheck.js

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
CMD ["dumb-init", "node", "dist/server.js"]